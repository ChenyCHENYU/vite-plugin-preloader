// ============================================================================
// âš¡ src/runtime.ts - è¿è¡Œæ—¶ä»£ç æ¨¡æ¿ï¼ˆå­—ç¬¦ä¸²ï¼‰
// ============================================================================

export const runtimeTemplate = `// ðŸš€ Auto-generated by vite-plugin-preloader
import { ref, defineComponent, h, onMounted } from 'vue'

interface PreloadRoute {
  path: string
  component: () => Promise<any>
  reason: string
  priority: number
}

interface PreloadStats {
  total: number
  completed: number
  failed: number
  startTime: number
  endTime: number
}

// ðŸŽ¯ é¢„åŠ è½½é…ç½®ï¼ˆæž„å»ºæ—¶æ³¨å…¥ï¼‰
const PRELOAD_ROUTES = __PRELOAD_ROUTES__
const PRELOAD_OPTIONS = __PRELOAD_OPTIONS__

class PreloaderManager {
  private preloadedRoutes = new Set()
  private isPreloading = ref(false)
  private stats = ref({
    total: 0, completed: 0, failed: 0, startTime: 0, endTime: 0
  })

  async start() {
    if (this.isPreloading.value) return

    this.isPreloading.value = true
    this.stats.value = {
      total: PRELOAD_ROUTES.length,
      completed: 0, failed: 0,
      startTime: Date.now(), endTime: 0
    }

    console.log(\`ðŸš€ [é¢„åŠ è½½] å¼€å§‹é¢„åŠ è½½ \${PRELOAD_ROUTES.length} ä¸ªé¡µé¢\`)

    const sortedRoutes = [...PRELOAD_ROUTES].sort((a, b) => a.priority - b.priority)
    
    for (const route of sortedRoutes) {
      await this.preloadSingle(route)
      await this.sleep(100)
    }

    this.stats.value.endTime = Date.now()
    this.isPreloading.value = false
    
    console.log(\`ðŸŽ‰ [é¢„åŠ è½½] å®Œæˆ! è€—æ—¶ \${this.stats.value.endTime - this.stats.value.startTime}ms\`)
  }

  async preloadSingle(route) {
    if (this.preloadedRoutes.has(route.path)) return

    try {
      const startTime = Date.now()
      await route.component()
      const loadTime = Date.now() - startTime
      
      this.preloadedRoutes.add(route.path)
      this.stats.value.completed++
      console.log(\`âœ… [é¢„åŠ è½½] \${route.path} (\${loadTime}ms) - \${route.reason}\`)
    } catch (error) {
      this.stats.value.failed++
      console.error(\`âŒ [é¢„åŠ è½½] \${route.path} å¤±è´¥:\`, error)
    }
  }

  sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms))
  }

  isPreloaded(path) {
    return this.preloadedRoutes.has(path)
  }

  getStats() {
    return {
      ...this.stats.value,
      preloadedPaths: Array.from(this.preloadedRoutes),
      isPreloading: this.isPreloading.value
    }
  }

  createStatusComponent() {
    const self = this
    return defineComponent({
      name: 'PreloadStatus',
      setup() {
        onMounted(() => {
          if (!document.getElementById('preloader-styles')) {
            const style = document.createElement('style')
            style.id = 'preloader-styles'
            const position = PRELOAD_OPTIONS.statusPosition.replace('-', ': 20px; ') + ': 20px;'
            style.textContent = \`
              .preloader-status {
                position: fixed; \${position}
                background: rgba(0,0,0,0.8); color: white; padding: 8px 16px;
                border-radius: 6px; font-size: 12px; z-index: 9999;
                pointer-events: none; font-family: system-ui;
              }
            \`
            document.head.appendChild(style)
          }
        })

        return () => {
          if (!self.isPreloading.value || !import.meta.env.DEV || !PRELOAD_OPTIONS.showStatus) {
            return null
          }
          return h('div', { class: 'preloader-status' }, [
            'ðŸ”„ æ­£åœ¨ä¼˜åŒ–é¡µé¢... ',
            \`\${self.stats.value.completed}/\${self.stats.value.total}\`
          ])
        }
      }
    })
  }
}

// ðŸš€ å…¨å±€å®žä¾‹
const preloader = new PreloaderManager()

// ðŸ› ï¸ å¼€å‘çŽ¯å¢ƒè°ƒè¯•å·¥å…·
if (import.meta.env.DEV && PRELOAD_OPTIONS.debug) {
  window.preloaderDebug = {
    stats: () => preloader.getStats(),
    restart: () => preloader.start(),
    check: (path) => preloader.isPreloaded(path),
    help: () => console.log('ðŸ› ï¸ é¢„åŠ è½½è°ƒè¯•: stats() | restart() | check(path)')
  }
  console.log('ðŸ› ï¸ é¢„åŠ è½½è°ƒè¯•å·¥å…·: window.preloaderDebug')
}

// ðŸŽ¯ å¯¼å‡º
export const usePreloader = () => ({
  start: () => preloader.start(),
  isPreloaded: (path) => preloader.isPreloaded(path),
  StatusComponent: preloader.createStatusComponent()
})

// ðŸš€ è‡ªåŠ¨å¯åŠ¨
if (typeof window !== 'undefined') {
  setTimeout(() => preloader.start(), PRELOAD_OPTIONS.delay || 2000)
}`